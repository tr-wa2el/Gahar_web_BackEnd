# ?? Gahar Backend - Complete Implementation Guide

## ?? ???? ????

Gahar Backend ?? ???? CMS (Content Management System) ????? ???? ??? .NET 8 ?? ???? ????? ???? ?????? ??????.

## ? ??????? ????????

### ?? ?????? ?????????
- ? JWT Authentication
- ? Role-Based Access Control (RBAC)
- ? Permission-Based Authorization
- ? BCrypt Password Hashing
- ? Account Locking (??? 5 ??????? ?????)
- ? Password Complexity Requirements

### ?? ????? ????????
- ? Entity Framework Core 8
- ? SQL Server
- ? Code-First Approach
- ? Automatic Migrations
- ? Soft Delete Support
- ? Audit Trail
- ? Multi-language Support

### ??? ?????? ???????
- ? Repository Pattern
- ? Dependency Injection
- ? Clean Architecture
- ? Extension Methods
- ? Custom Middleware
- ? Action Filters

### ?? ??????? ???????
- ? Comprehensive Audit Logging
- ? User Activity Tracking
- ? IP Address Logging
- ? User Agent Tracking
- ? Change History (Old/New Values)

### ?? ????? ????? ??????
- ? Arabic (???????)
- ? English
- ? Extensible Translation System
- ? RTL Support

## ?? ????? ??????

### ????????? ????????

- .NET 8 SDK
- SQL Server 2019+
- Visual Studio 2022 ?? VS Code
- Git

### ???????

```bash
# ??????? ???????
git clone https://github.com/tr-wa2el/Gahar_web_BackEnd.git
cd Gahar_web_BackEnd

# ??????? ?????
cd Gahar_Backend
dotnet restore

# ????? ????? ????????
dotnet ef database update

# ????? ???????
dotnet run
```

### ???????

1. **????? ????????**: ?? ?????? `appsettings.json`

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=.;Database=GaharDB;Trusted_Connection=True;TrustServerCertificate=True;"
  }
}
```

2. **JWT Settings**: ???? ?? ????? ??????? ????? ?? ???????

```json
{
  "JwtSettings": {
  "SecretKey": "YourSuperSecretKeyHere_MinLength32Characters!",
    "Issuer": "GaharBackend",
"Audience": "GaharClients",
    "AccessTokenExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  }
}
```

## ?? ???? ???????

```
Gahar_Backend/
??? Controllers/      # API Endpoints
?   ??? AuthController.cs    # Authentication endpoints
??? Models/
?   ??? Entities/         # Database entities
?   ??? DTOs/     # Data transfer objects
?   ??? ViewModels/     # Response models
??? Data/
?   ??? ApplicationDbContext.cs
?   ??? Configurations/      # Entity configurations
??? Services/
?   ??? Interfaces/
?   ??? Implementations/
??? Repositories/
?   ??? Interfaces/
?   ??? Implementations/
??? Middleware/      # Custom middleware
??? Filters/      # Action filters
??? Utilities/          # Helper classes
?   ??? DataSeeder.cs       # Database seeding
?   ??? Exceptions/         # Custom exceptions
??? Constants/        # Constants & permissions
??? Extensions/      # Extension methods
```

## ?? ???????? ??????????

??? ????? ??????? ???? ???? ??? ????? ???? SuperAdmin ????????:

```
Email: admin@gahar.sa
Password: Admin@123
```

?? **?????**: ?? ?????? ???? ?????? ????? ?? ???? ???????!

## ?? API Endpoints

### Authentication

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/api/auth/login` | ????? ?????? | ? |
| POST | `/api/auth/register` | ????? ?????? ???? | ? |
| POST | `/api/auth/logout` | ????? ?????? | ? |
| POST | `/api/auth/change-password` | ????? ???? ?????? | ? |
| POST | `/api/auth/reset-password` | ????? ????? ???? ?????? | ? |
| POST | `/api/auth/refresh-token` | ????? Access Token | ? |
| GET | `/api/auth/me` | ??????? ???????? ?????? | ? |

### ????? ?????????

#### ????? ??????

```bash
curl -X POST https://localhost:7000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@gahar.sa",
    "password": "Admin@123"
  }'
```

**Response:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "base64_encoded_refresh_token",
  "expiresAt": "2025-01-11T12:00:00Z",
  "user": {
    "id": 1,
    "username": "superadmin",
    "email": "admin@gahar.sa",
    "firstName": "Super",
    "lastName": "Admin",
    "roles": ["SuperAdmin"]
  }
}
```

#### ??????? Token

```bash
curl -X GET https://localhost:7000/api/auth/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## ?? ??????????

### ????? ???? ??????????

```bash
cd Gahar_Backend.Tests
dotnet test
```

### ????? ???????? ?????

```bash
dotnet test --filter "FullyQualifiedName~AuthServiceTests"
```

### ????? ???????

```bash
dotnet test --collect:"XPlat Code Coverage"
```

### ????? ??????????

- ? **91/91 ??????** ??? (100%)
- ? Entity Tests: 15 ??????
- ? Service Tests: 40 ??????
- ? Repository Tests: 25 ??????
- ? Middleware Tests: 10 ????????
- ? Filter Tests: 10 ????????
- ? DTO Tests: 15 ??????

## ?? ????? ????????

### ??????? ????????

| Table | Description |
|-------|-------------|
| Users | ??????? ?????????? |
| Roles | ??????? |
| Permissions | ????????? |
| UserRoles | ??? ?????????? ???????? |
| RolePermissions | ??? ??????? ?????????? |
| AuditLogs | ????? ??????? |
| Languages | ?????? ???????? |
| Translations | ???????? |

### Entity Relationships

```
User (1) ??????> (*) UserRole (*) <?????? (1) Role
   ?
     ?
        v
          (1) RolePermission (*)
     ?
       ?
      v
              (1) Permission

Language (1) ??????> (*) Translation
```

## ?? ????????? ????????

### Entity Configurations

???? ???????? ????? ??????? ????? ?? ???? `Data/Configurations/`:

- `UserConfiguration.cs` - ????? ????? ?????? ?????????? ???? ????????
- `RoleConfiguration.cs` - ???? ???? ?????
- `PermissionConfiguration.cs` - ???? ???? ????? ?????????
- `AuditLogConfiguration.cs` - ????? ????? ??????
- `LanguageConfiguration.cs` - ???? ???? ???? ?????
- `TranslationConfiguration.cs` - ???? ???? ????

### Extension Methods

#### ClaimsPrincipalExtensions

```csharp
var userId = User.GetUserId();
var email = User.GetUserEmail();
var roles = User.GetUserRoles();
var hasPermission = User.HasPermission("Users.Create");
```

#### QueryableExtensions

```csharp
var result = await query
    .WhereIf(searchTerm != null, x => x.Name.Contains(searchTerm))
    .ToPaginatedListAsync(pageNumber, pageSize);
```

#### StringExtensions

```csharp
var slug = title.ToSlug();
var isValid = email.IsValidEmail();
var truncated = text.Truncate(100);
```

## ?? ?????????

### ??????? ??????????

| Role | Description | Permissions |
|------|-------------|-------------|
| SuperAdmin | ???? ?????? | ???? ????????? |
| Admin | ???? | ???? ????????? |
| Editor | ???? | ??????? ??????? |
| Viewer | ????? | ??????? ??????? ??? |

### ??????? ?????????

```csharp
[Permission("Users.Create")]
public async Task<IActionResult> CreateUser([FromBody] CreateUserDto dto)
{
    // Only users with "Users.Create" permission can access this
}
```

## ?? ???????? ????????

### Audit Logging

?? ????? ?? ?????? ??? ??????? ????????:

```csharp
await _auditLogService.LogAsync(
    userId: currentUser.Id,
    action: "Create",
    entityType: "User",
    entityId: newUser.Id,
    description: "Created new user",
    oldValues: null,
    newValues: newUser
);
```

### ??????? Audit Log

- User ID
- Action Type
- Entity Type & ID
- Old/New Values (JSON)
- IP Address
- User Agent
- Timestamp

## ?? ??? ???????

### ??????? ???????

1. **????? ????????**
   - SQL Server 2019+
   - Connection String ???
   - Automatic backups

2. **??????**
   - ????? JWT Secret Key
   - HTTPS ???
   - ????? CORS ???????? ???????
   - Rate Limiting

3. **????????**
 - Application Insights
   - Logging (Serilog)
- Health Checks

### Docker Support (??????)

```dockerfile
# Dockerfile example
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443
```

## ?? ????????

???? ??????????! ????:

1. Fork ???????
2. ????? branch ???? (`git checkout -b feature/AmazingFeature`)
3. Commit ???????? (`git commit -m 'Add some AmazingFeature'`)
4. Push ??? Branch (`git push origin feature/AmazingFeature`)
5. ??? Pull Request

## ?? ???????

??? ??????? ???? ??? MIT License.

## ?? ?????

- GitHub Issues: [Issues](https://github.com/tr-wa2el/Gahar_web_BackEnd/issues)
- Email: support@gahar.sa

## ?? ??????? ???????

- [API Documentation](docs/API.md) - ??????
- [Database Schema](docs/DATABASE.md) - ??????
- [Deployment Guide](docs/DEPLOYMENT.md) - ??????

---

**?? ??????? ??????:** ???? Gahar  
**???????:** v1.0.0  
**????? ??? ?????:** 11 ????? 2025

?? **??????? ???? ????????? ????????!**
