# ๐ ูุธุงู ุงูุตูุงุญูุงุช ุญุณุจ ุงูุฃูุณุงู - ุชู ุงูุฅูุฌุงุฒ! โ

## ๐ ููุฎุต ุงูุชูููุฐ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุฏู ููุชุญูู ุจุงูุตูุงุญูุงุช ุญุณุจ ุงูุฃูุณุงู ุญูุซ:

```
โ ูู ูุณู (HR, ACCOUNTING, ุฅูุฎ) ูุดูู ููุท ุจูุงูุงุช ูุณูู
โ ุนูุฏ ุฅูุดุงุก ูููุฐุฌุ ูู ุงููุงุณ ูู ููุณ ุงููุณู ูุดูููู
โ ุงูุฃูุณุงู ุงูุฃุฎุฑู ูุง ุชุดูู ููุงุฐุฌ ุจุนุถูุง
โ Admin ูุดูู ุฌููุน ุงูููุงุฐุฌ ูู ุฌููุน ุงูุฃูุณุงู
โ ุฑุฆูุณ ุงููุณู ูู ุตูุงุญูุงุช ุฅุถุงููุฉ
```

---

## ๐ ุงููููุงุช ุงููููุดุฃุฉ/ุงูููุนุฏูุฉ

### โจ ูููุงุช ุฌุฏูุฏุฉ:

```
โ Gahar_Backend/Models/Entities/Department.cs
   โโ ูููุฐุฌ ุงููุณู ุจุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ

โ Gahar_Backend/Services/DepartmentAccessService.cs
   โโ ุฎุฏูุฉ ุงูุชุญูู ุจุงูุตูุงุญูุงุช (Interface + Implementation)

โ Gahar_Backend/Controllers/DepartmentsController.cs
   โโ API Controller ููุฃูุณุงู (CRUD + ููุธููู)

โ DEPARTMENT_ACCESS_CONTROL.md
   โโ ุชูุซูู ูุงูู ูููุธุงู
```

### ๐ง ูููุงุช ูุนุฏููุฉ:

```
โ Gahar_Backend/Models/Entities/User.cs
   โโ ุฃุถูู: DepartmentId ู Department property

โ Gahar_Backend/Models/Entities/Form.cs
   โโ ุฃุถูู: DepartmentId ู Department property

โ Gahar_Backend/Data/ApplicationDbContext.cs
   โโ ุฃุถูู: DbSet<Department>

โ Gahar_Backend/Program.cs
   โโ ุชุณุฌูู: DepartmentAccessService ูู DI
```

---

## ๐๏ธ ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1๏ธโฃ ูููุฐุฌ Department

```csharp
public class Department : BaseEntity
{
    public string Name { get; set; }           // ุงุณู ุงููุณู
    public string? NameAr { get; set; }        // ุงูุงุณู ุจุงูุนุฑุจูุฉ
    public string? Description { get; set; }   // ุงููุตู
    public string? Code { get; set; }          // ุงูููุฏ (ูุซูุงู: HR)
  public Guid? HeadId { get; set; }      // ุฑุฆูุณ ุงููุณู
    public bool IsActive { get; set; }  // ูู ูุนุงู
    public int DisplayOrder { get; set; }      // ุชุฑุชูุจ ุงูุนุฑุถ
    
    // ุงูููุธููู ูุงูููุงุฐุฌ
    public ICollection<User> Users { get; set; }
    public ICollection<Form> Forms { get; set; }
}
```

---

### 2๏ธโฃ ุฎุฏูุฉ ุงูุชุญูู ุจุงูุตูุงุญูุงุช

```csharp
public interface IDepartmentAccessService
{
    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููุชูู ููุณู ูุนูู
    Task<bool> IsUserInDepartmentAsync(Guid userId, Guid departmentId);
    
    // ุงูุญุตูู ุนูู ูุณู ุงููุณุชุฎุฏู
    Task<Department?> GetUserDepartmentAsync(Guid userId);
    
    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููููู ุงููุตูู ููููุฐุฌ
    Task<bool> CanUserAccessFormAsync(Guid userId, Guid formId);
    
    // ุงูุญุตูู ุนูู ุงูููุงุฐุฌ ุงููุชุงุญุฉ ูููุณุชุฎุฏู
 Task<List<Form>> GetDepartmentFormsAsync(Guid userId);
    
    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุฑุฆูุณ ุงููุณู
    Task<bool> IsUserDepartmentHeadAsync(Guid userId);
    
    // ุงูุญุตูู ุนูู ููุธูู ุงููุณู
    Task<List<User>> GetDepartmentEmployeesAsync(Guid userId);
    
    // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุชุนุฏูู
    Task<bool> CanUserEditFormAsync(Guid userId, Guid formId);
}
```

---

### 3๏ธโฃ API ููุฃูุณุงู

```bash
# ุงูุญุตูู ุนูู ุฌููุน ุงูุฃูุณุงู (Admin ููุท)
GET /api/departments

# ุงูุญุตูู ุนูู ูุณู ูุนูู
GET /api/departments/{id}

# ุฅูุดุงุก ูุณู ุฌุฏูุฏ (Admin ููุท)
POST /api/departments
{
  "name": "HR",
  "nameAr": "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ",
  "description": "...",
  "code": "HR"
}

# ุชุญุฏูุซ ูุณู (Admin ููุท)
PUT /api/departments/{id}

# ุงูุญุตูู ุนูู ููุธูู ุงููุณู
GET /api/departments/{id}/employees

# ุชุนููู ุฑุฆูุณ ุงููุณู (Admin ููุท)
POST /api/departments/{id}/set-head/{userId}
```

---

## ๐ ููุทู ุงูุตูุงุญูุงุช

### ๐๏ธ ูู ููููู ุฑุคูุฉ ุงููููุฐุฌุ

```
โ Admin ู SuperAdmin:   ูุดูููุง ุฌููุน ุงูููุงุฐุฌ
โ ููุธู ุนุงุฏู:    ูุดูู ููุงุฐุฌ ูุณูู ููุท
โ ููุธู ูู ูุณู ุขุฎุฑ:     ูุง ูุดูู ุงููููุฐุฌ
```

### โ๏ธ ูู ููููู ุชุนุฏูู ุงููููุฐุฌุ

```
โ Admin ู SuperAdmin:    ูุนุฏููุง ุฃู ูููุฐุฌ
โ ูู ุฃูุดุฃ ุงููููุฐุฌ:      ูุนุฏู ูููุฐุฌู
โ ุฑุฆูุณ ุงููุณู:       ูุนุฏู ููุงุฐุฌ ูุณูู
โ ุงูุขุฎุฑูู:       ูุง ูููููู ุงูุชุนุฏูู
```

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู: ุดุฑูุฉ ุจูุง ุฃูุณุงู ูุฎุชููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุณู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (HR)        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุฑุฆูุณ ุงููุณู: ุฃุญูุฏ ูุญูุฏ          โ
โ ุงูููุธููู:โ
โ  โโ ูุงุทูุฉ ุนูู         โ
โ  โโ ูุญููุฏ ุณุงูู       โ
โ     โ
โ ุงูููุงุฐุฌ ุงููุชุงุญุฉ:         โ
โ  โโ ุทูุจ ุฅุฌุงุฒุฉ                โ
โ  โโ ุทูุจ ุชูุฑูุฑ ุทุจู        โ
โ  โโ ุทูุจ ุชุฏุฑูุจ        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุณู ุงูุญุณุงุจุงุช (ACCOUNTING) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุฑุฆูุณุฉ ุงููุณู: ุณุงุฑุฉ ุฃุญูุฏ      โ
โ ุงูููุธููู: โ
โ  โโ ุนูู ูุญููุฏ           โ
โ  โโ ููุฑ ูุญูุฏ       โ
โ        โ
โ ุงูููุงุฐุฌ ุงููุชุงุญุฉ:          โ
โ  โโ ุทูุจ ูุงูู       โ
โ  โโ ุชูุฑูุฑ ุงูููุงุชูุฑ       โ
โ  โโ ุทูุจ ุตุฑู โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ูุง ูุญุฏุซ ุนูุฏ ุฅูุดุงุก ูููุฐุฌ:

```
1. ุฃุญูุฏ ูุญูุฏ (ูู HR) ููุดุฆ "ุทูุจ ุฅุฌุงุฒุฉ"
   โ
2. ุงููููุฐุฌ ููุญูุธ ูุน DepartmentId = HR
   โ
3. โ ูุงุทูุฉ ุนูู (ูู HR) ุชุดูู ุงููููุฐุฌ
4. โ ูุญููุฏ ุณุงูู (ูู HR) ูุดูู ุงููููุฐุฌ
5. โ ุณุงุฑุฉ ุฃุญูุฏ (ูู ACCOUNTING) ูุง ุชุดูู ุงููููุฐุฌ
6. โ Admin ูุดูู ุงููููุฐุฌ
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุฎุทูุฉ 1: ุฅูุดุงุก ุฃูุณุงู

```bash
# ูุณู HR
POST /api/departments
{
  "name": "HR",
  "nameAr": "ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ",
  "code": "HR",
  "displayOrder": 1
}

# ูุณู ACCOUNTING
POST /api/departments
{
  "name": "Accounting",
  "nameAr": "ุงูุญุณุงุจุงุช",
  "code": "ACC",
  "displayOrder": 2
}
```

### ุงูุฎุทูุฉ 2: ุชุนููู ุงูููุธููู ููุฃูุณุงู

```bash
# ุชุนุฏูู ููุธู ููุตุจุญ ูู ูุณู HR
PUT /api/users/{userId}
{
  "departmentId": "{HR_DEPARTMENT_ID}"
}
```

### ุงูุฎุทูุฉ 3: ุชุนููู ุฑุคุณุงุก ุงูุฃูุณุงู

```bash
# ุชุนููู ุฃุญูุฏ ูุญูุฏ ุฑุฆูุณ ูุณู HR
POST /api/departments/{hr-id}/set-head/{ahmed-id}
```

### ุงูุฎุทูุฉ 4: ุฅูุดุงุก ููุงุฐุฌ

```bash
# ููุธู ูู HR ููุดุฆ ูููุฐุฌ ูู ูุณูู
POST /api/forms
{
  "title": "ุทูุจ ุฅุฌุงุฒุฉ",
  "titleAr": "ุทูุจ ุฅุฌุงุฒุฉ",
  "description": "ูููุฐุฌ ุทูุจ ุฅุฌุงุฒุฉ"
}

# ุงููููุฐุฌ ุณูููุดุฃ ุชููุงุฆูุงู ูู ูุณู ุงูููุธู ุงูุญุงูู
```

### ุงูุฎุทูุฉ 5: ุงูุญุตูู ุนูู ุงูููุงุฐุฌ

```bash
# ููุธู ูู HR
GET /api/forms
# ูุญุตู ุนูู: ุทูุจ ุฅุฌุงุฒุฉุ ุชูุฑูุฑ ุทุจูุ ุชุฏุฑูุจ (ููุงุฐุฌ HR ููุท)

# ููุธู ูู ACCOUNTING
GET /api/forms
# ูุญุตู ุนูู: ุทูุจ ูุงููุ ุชูุฑูุฑ ููุงุชูุฑุ ุทูุจ ุตุฑู (ููุงุฐุฌ ACCOUNTING ููุท)

# Admin
GET /api/forms
# ูุญุตู ุนูู: ุฌููุน ุงูููุงุฐุฌ
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### Test Case 1: ููุธู ูุดูู ููุงุฐุฌ ูุณูู

```bash
# 1. ุชุณุฌูู ุฏุฎูู ููุธู HR
POST /api/auth/login
{
  "email": "fatima@company.com",
  "password": "password123"
}

# 2. ุงูุญุตูู ุนูู ุงูููุงุฐุฌ
GET /api/forms

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูููุฐุฌ "ุทูุจ ุฅุฌุงุฒุฉ" (ูู ูุณู HR)
โ ูููุฐุฌ "ุทูุจ ูุงูู" (ูู ูุณู ACCOUNTING) - ูุง ูุธูุฑ
```

### Test Case 2: ุงููุตูู ุงููุจุงุดุฑ ููููุฐุฌ ุขุฎุฑ

```bash
# ููุธู ูู ACCOUNTING ูุญุงูู ุงููุตูู ููููุฐุฌ HR
GET /api/forms/{hr-form-id}

# ุงููุชูุฌุฉ:
โ 403 Forbidden
{
  "message": "ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐุง ุงููููุฐุฌ"
}
```

### Test Case 3: Admin ูุดูู ูู ุดูุก

```bash
# 1. ุชุณุฌูู ุฏุฎูู Admin
POST /api/auth/login
{
  "email": "admin@company.com",
  "password": "admin123"
}

# 2. ุงูุญุตูู ุนูู ุงูููุงุฐุฌ
GET /api/forms

# ุงููุชูุฌุฉ:
โ ูููุฐุฌ "ุทูุจ ุฅุฌุงุฒุฉ" (HR)
โ ูููุฐุฌ "ุทูุจ ูุงูู" (ACCOUNTING)
โ ุฌููุน ุงูููุงุฐุฌ ุงูุฃุฎุฑู
```

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู ุงููุงุฏูุฉ

### 1๏ธโฃ ุฅูุดุงุก Database Migration

```bash
# ูู ูุฌูุฏ ุงููุดุฑูุน
dotnet ef migrations add AddDepartmentAccessControl

# ุชุทุจูู ุงูู Migration
dotnet ef database update
```

### 2๏ธโฃ ุงุฎุชุจุงุฑ ุงููุธุงู ุงููุงูู

```bash
# 1. ุชุดุบูู ุงูุชุทุจูู
dotnet run

# 2. ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช
# - ุฅูุดุงุก ุฃูุณุงู
# - ุชุนููู ููุธููู
# - ุฅูุดุงุก ููุงุฐุฌ
# - ุงุฎุชุจุงุฑ ุงููุตูู
```

### 3๏ธโฃ ุชุญุฏูุซุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ)

```
- ุฅุถุงูุฉ ุตูุญุฉ ูุฅุฏุงุฑุฉ ุงูุฃูุณุงู ูู ุงูู Frontend
- ุฅุถุงูุฉ ุฎุตุงุฆุต ุฅุถุงููุฉ ููุฃูุณุงู
- ุฅุถุงูุฉ ุชูุงุฑูุฑ ุญุณุจ ุงููุณู
- ุฅุถุงูุฉ ุฅุดุนุงุฑุงุช ุฏุงุฎู ุงููุณู
```

---

## โ Build Status

```
โ Build:       SUCCESSFUL
โ Errors:      0
โ Warnings:    0
โ Code:    Compiled Successfully
โ Ready to:    Database Migration
```

---

## ๐ ุงููููุงุช ุงููุฑุฌุนูุฉ

| ุงูููู | ุงููุตู | ุงููููุน |
|------|--------|--------|
| `Department.cs` | ูููุฐุฌ ุงููุณู | `Models/Entities/` |
| `DepartmentAccessService.cs` | ุฎุฏูุฉ ุงูุตูุงุญูุงุช | `Services/` |
| `DepartmentsController.cs` | API ููุฃูุณุงู | `Controllers/` |
| `DEPARTMENT_ACCESS_CONTROL.md` | ุงูุชูุซูู ุงููุงูู | ุงูุฌุฐุฑ |
| `User.cs` | ูุนุฏู | `Models/Entities/` |
| `Form.cs` | ูุนุฏู | `Models/Entities/` |

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

```
1. ุชูููุฐ Migration:
   dotnet ef migrations add AddDepartmentAccessControl
   dotnet ef database update

2. ุงุฎุชุจุงุฑ ุงูู APIs:
   - POST /api/departments (ุฅูุดุงุก)
   - GET /api/departments (ูุงุฆูุฉ)
   - GET /api/forms (ููุงุฐุฌ ุงููุณู)

3. ุชุฌุฑุจุฉ ุงูุณููุงุฑูููุงุช ุงููุฎุชููุฉ

4. ุฅุฐุง ูู ุดูุก ุชูุงูุ ูููู ุฏูุฌ ูู ุงูู Frontend
```

---

## ๐ก ููุงุญุธุงุช ูููุฉ

```
โ ุงููุธุงู ูุนูู ูุน ุงูู .NET 8
โ ุงูุชูุซูู ูุงููุฉ ููุงุถุญุฉ
โ ุฌุงูุฒ ููุฅูุชุงุฌ ุจุนุฏ Migration
โ ูููู ุชูุณูุนู ุจุณูููุฉ ูู ุงููุณุชูุจู
โ๏ธ  ูุฌุจ ุชุดุบูู Migration ูุจู ุงูุงุณุชุฎุฏุงู
โ๏ธ  ุงูุชุฃูุฏ ูู ุชุนููู DepartmentId ููููุธููู ุงูููุฌูุฏูู
```

---

**Status**: โ **READY FOR DATABASE MIGRATION**  
**Build**: โ **SUCCESSFUL**  
**Next Step**: `dotnet ef migrations add AddDepartmentAccessControl`

---

ูู ุชุฑูุฏ ุฃู ุชูุถูุญุงุช ุฃู ุชุนุฏููุงุชุ ๐ค

ุงุณุชูุชุน ุจุงููุธุงู ุงูุฌุฏูุฏ! ๐
